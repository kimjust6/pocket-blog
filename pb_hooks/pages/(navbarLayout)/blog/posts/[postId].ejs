<script server>
    const { POCKET_BLOGPOSTS } = resolve('../../utils/constants')

    const client = pb({ request })
    let blogposts
    let singleBlog = null
    let page = params.page ?? 1
    const perPage = params.perPage ?? 6

    if (params?.postId) {
        try {
            singleBlog = client
                .collection(POCKET_BLOGPOSTS)
                .getFirstListItem(
                    `id = "${params.postId}" && isDeleted = false`,
                    { sort: '-created' }
                )
        } catch (error) {
            console.error('Error fetching single blog post: ', error)
            singleBlog = null
        }
    }

    // let records = $app.findRecordsByFilter(
    //     'blogposts', // collection
    //     'isDeleted = false && tags ~ {:tag}', // filter (relation expand)
    //     '-created', // sort
    //     10, // limit
    //     0, // offset
    //     { tag: 'random' } // filter params
    // )
    // records.forEach((record) => {
    //     $app.expandRecord(record, ['user'], null)
    // })
</script>

<% if (typeof(params.postId) === "undefined") { %>
<%- include('blogcards.ejs') %>
<% } else if (singleBlog === null) { %>
<%- include('pagenotfound.ejs') %>
<% } else { %>
<%- include('blogpage.ejs', { singleBlog }) %>
<% } %>
