<script server>
    const { POCKET_BLOGPOSTS } = resolve('../../utils/constants')

    let isLoading = true
    // Get an authenticated client for the current request
    const client = pb({ request })
    let blogposts
    let singleBlog = null
    let page = params.page ?? 1
    const perPage = params.perPage ?? 6

    if (params?.postId) {
        try {
            singleBlog = client
                .collection(POCKET_BLOGPOSTS)
                .getFirstListItem(
                    `id = "${params.postId}" && isDeleted = false`,
                    { sort: '-created' }
                )
        } catch (error) {
            console.error('Error fetching single blog post: ', error)
            singleBlog = null
        }
    } else {
        try {
            blogposts = client
                .collection(POCKET_BLOGPOSTS)
                .getList(page, perPage, {
                    sort: '-created',
                    filter: 'isDeleted = false',
                })
            if (blogposts?.page > blogposts.totalPages) {
                page = blogposts.totalPages
            }

            blogposts = client
                .collection(POCKET_BLOGPOSTS)
                .getList(page, perPage, {
                    sort: '-created',
                    filter: 'isDeleted = false',
                })
        } catch (error) {
            console.error('Error fetching blog posts: ', error)
            blogposts = { items: [] }
        }
    }
    isLoading = false

    // let records = $app.findRecordsByFilter(
    //     'blogposts', // collection
    //     'isDeleted = false && tags ~ {:tag}', // filter (relation expand)
    //     '-created', // sort
    //     10, // limit
    //     0, // offset
    //     { tag: 'random' } // filter params
    // )
    // records.forEach((record) => {
    //     $app.expandRecord(record, ['user'], null)
    // })
    // console.log(JSON.stringify(records[0].expandedOne('user')))
</script>

<% if (isLoading) { %>
<%- include('loading.ejs') %>
<% } else if (typeof(params.postId) === "undefined") { %>
<%- include('blogcards.ejs', { blogposts }) %>
<% } else if (singleBlog === null) { %>
<%- include('pagenotfound.ejs') %>
<% } else { %>
<%- include('blogpage.ejs', { singleBlog }) %>
<% } %>
