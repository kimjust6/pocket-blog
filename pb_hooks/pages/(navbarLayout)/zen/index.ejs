<script server>
    // Use server-side helper to fetch the Discord Bot token (kept out of source)
    const { getDiscordBotToken } = resolve('../../utils/common')
    const DISCORD_BOT_TOKEN = getDiscordBotToken()

    // define target user and message (TODO: make dynamic / form-driven)
    const userId = '90909125164163072' // Replace with actual Discord user ID
    const message = 'test'

    let result = null
    let error = null
    let dmChannel = null
    let diagnostics = {}

    function decodeBody(raw) {
        if (raw == null) return ''
        if (typeof raw === 'string') return raw
        if (raw instanceof Uint8Array) {
            try {
                return new TextDecoder().decode(raw)
            } catch {
                return ''
            }
        }
        if (Array.isArray(raw)) {
            try {
                return new TextDecoder().decode(Uint8Array.from(raw))
            } catch {
                return raw.map((n) => String.fromCharCode(n)).join('')
            }
        }
        return ''
    }

    function safeParse(raw) {
        const text = decodeBody(raw)
        if (!text.trim()) return null
        try {
            return JSON.parse(text)
        } catch (err) {
            return { _raw: text.slice(0, 500), _parseError: err.message }
        }
    }

    try {
        if (!DISCORD_BOT_TOKEN) {
            throw new Error(
                'Missing Discord bot token (configure in admin settings)'
            )
        }

        // Step 1: Create DM channel
        const dmResponse = $http.send({
            url: 'https://discord.com/api/v10/users/@me/channels',
            method: 'POST',
            headers: {
                Authorization: 'Bot ' + DISCORD_BOT_TOKEN,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ recipient_id: userId }),
        })
        const dmStatus =
            dmResponse.status ??
            dmResponse.statusCode ??
            dmResponse.code ??
            null
        const dmJson = safeParse(dmResponse.body)
        diagnostics.dm = {
            status: dmStatus,
            responseKeys: Object.keys(dmResponse || {}),
            rawBodyPreview: decodeBody(dmResponse.body).slice(0, 200),
            parsed: dmJson,
        }
        const channelId = dmJson && dmJson.id
        const isSuccess = dmStatus === 200 || (!dmStatus && channelId)
        if (!isSuccess) {
            const reason =
                dmStatus === 401
                    ? 'Unauthorized (check bot token)'
                    : dmStatus === 403
                      ? 'Forbidden (privacy settings / no mutual server)'
                      : dmStatus === 429
                        ? 'Rate limited'
                        : 'HTTPS ' + dmStatus
            throw new Error('Failed to create DM channel: ' + reason)
        }
        if (!dmJson || dmJson._parseError) {
            throw new Error('DM channel response could not be parsed')
        }
        dmChannel = dmJson

        if (!dmChannel || !dmChannel.id) {
            throw new Error('DM channel response malformed or missing id')
        }

        // Step 2: Send message
        const sendResponse = $http.send({
            url: `https://discord.com/api/v10/channels/${dmChannel.id}/messages`,
            method: 'POST',
            headers: {
                Authorization: 'Bot ' + DISCORD_BOT_TOKEN,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ content: message }),
        })
        const sendStatus =
            sendResponse.status ??
            sendResponse.statusCode ??
            sendResponse.code ??
            null
        const sendJson = safeParse(sendResponse.body)
        diagnostics.send = {
            status: sendStatus,
            responseKeys: Object.keys(sendResponse || {}),
            rawBodyPreview: decodeBody(sendResponse.body).slice(0, 200),
            parsed: sendJson,
        }
        const sendId = sendJson && (sendJson.id || sendJson.message?.id)
        const sendSuccess = sendStatus === 200 || (!sendStatus && sendId)
        if (!sendSuccess) {
            const reason =
                sendStatus === 401
                    ? 'Unauthorized (token invalid or missing scope)'
                    : sendStatus === 403
                      ? 'Forbidden (cannot send to that channel)'
                      : sendStatus === 429
                        ? 'Rate limited'
                        : 'HTTPS ' + sendStatus
            throw new Error('Failed to send message: ' + reason)
        }
        if (!sendJson || sendJson._parseError) {
            throw new Error('Message response could not be parsed')
        }
        result = sendJson
    } catch (err) {
        error = err?.message || String(err)
    }
</script>
<% if (error) { %>
<p style="color: red">Error: <%= error %></p>
<details class="mt-4">
    <summary>Diagnostics</summary>
    <pre><%= JSON.stringify({
    tokenPresent: !!DISCORD_BOT_TOKEN,
    tokenMasked: DISCORD_BOT_TOKEN ? (DISCORD_BOT_TOKEN.slice(0, 6) + '...' + DISCORD_BOT_TOKEN.slice(-4)) : null,
    userId,
    diagnostics
}, null, 2) %></pre>
</details>
<% } else if (result) { %>
<h3>Discord message sent successfully!</h3>
<pre><%= JSON.stringify(result, null, 2) %></pre>
<% } else { %>
<p>No result.</p>
<% } %>
